import os
import time
import subprocess
import xml.etree.ElementTree as ET
import re

from gui.automation.tap_create_short_button import tap_create_button, tap_short_button
from .tap_add_gallery_button import tap_add_gallery_button
from .tap_upload_short import tap_upload_short
from .tap_video_by_id import tap_video_by_id
from .tap_next_button import tap_next_button
from .tap_done_button import tap_done_button
from .tap_add_sound_button import tap_add_sound_button
from .pick_first_music_and_next import pick_first_music_and_next
from .search_music import search_music
from .video_utils import get_video_id_for_serial
from .tap_checkmark_button import tap_checkmark_button
from .tap_next_button_final import tap_next_button_final
from .adjust_volume_dynamic import adjust_volume_dynamic
from .get_pust_title import set_title_from_video_id

ADB_PATH = "C:\\Users\\dell\\AppData\\Local\\Android\\Sdk\\platform-tools\\adb.exe"

def open_youtube(serial):
    print(f"[{serial}] üöÄ M·ªü YouTube...")
    os.system(f'"{ADB_PATH}" -s {serial} shell monkey -p com.google.android.youtube -c android.intent.category.LAUNCHER 1')
    time.sleep(3)

def dump_ui(serial):
    subprocess.run([ADB_PATH, "-s", serial, "shell", "uiautomator", "dump"], stdout=subprocess.DEVNULL)
    subprocess.run([ADB_PATH, "-s", serial, "pull", "/sdcard/window_dump.xml", f"window_dump_{serial}.xml"], stdout=subprocess.DEVNULL)

def wait_until_ui_has(serial, keyword, timeout=10):
    print(f"[{serial}] ‚è≥ Ch·ªù UI ch·ª©a '{keyword}'...")
    start = time.time()
    while time.time() - start < timeout:
        dump_ui(serial)
        try:
            tree = ET.parse(f"window_dump_{serial}.xml")
            root = tree.getroot()
            for node in root.iter():
                if (
                    keyword in node.attrib.get("content-desc", "") or
                    keyword in node.attrib.get("text", "") or
                    keyword in node.attrib.get("resource-id", "")
                ):
                    print(f"[{serial}] ‚úÖ T√¨m th·∫•y UI: '{keyword}'")
                    return True
        except Exception as e:
            print(f"[{serial}] ‚ö†Ô∏è L·ªói khi ƒë·ªçc XML: {e}")
        time.sleep(1)
    print(f"[{serial}] ‚ùå H·∫øt th·ªùi gian ch·ªù UI c√≥ '{keyword}'")
    return False

def wait_until_add_sound_visible(serial, max_wait=120):
    print(f"[{serial}] ‚è≥ Ch·ªù ƒë·∫øn khi th·∫•y n√∫t 'Add sound' (t·ªëi ƒëa {max_wait}s)...")
    start = time.time()
    xml_file = f"window_dump_{serial}.xml"

    while time.time() - start < max_wait:
        subprocess.run(["adb", "-s", serial, "shell", "uiautomator", "dump"], stdout=subprocess.DEVNULL)
        subprocess.run(["adb", "-s", serial, "pull", "/sdcard/window_dump.xml", xml_file], stdout=subprocess.DEVNULL)

        try:
            tree = ET.parse(xml_file)
            root = tree.getroot()
            for node in root.iter():
                if (
                    node.attrib.get("resource-id") == "com.google.android.youtube:id/sound_button_title" and
                    node.attrib.get("text") == "Add sound" and
                    node.attrib.get("enabled") == "true"
                ):
                    print(f"[{serial}] ‚úÖ ƒê√£ th·∫•y n√∫t 'Add sound'")
                    return True
        except Exception as e:
            print(f"[{serial}] ‚ö†Ô∏è L·ªói khi ƒë·ªçc XML: {e}")

        time.sleep(2)

    print(f"[{serial}] ‚ùå H·∫øt th·ªùi gian ch·ªù n√∫t 'Add sound'")
    return False

def wait_until_volume_ui_visible(serial, max_wait=60):
    print(f"[{serial}] ‚è≥ Ch·ªù giao di·ªán ch·ªânh √¢m l∆∞·ª£ng (t·ªëi ƒëa {max_wait}s)...")
    xml_file = f"window_dump_{serial}.xml"
    start = time.time()

    while time.time() - start < max_wait:
        subprocess.run(["adb", "-s", serial, "shell", "uiautomator", "dump"], stdout=subprocess.DEVNULL)
        subprocess.run(["adb", "-s", serial, "pull", "/sdcard/window_dump.xml", xml_file], stdout=subprocess.DEVNULL)

        try:
            tree = ET.parse(xml_file)
            root = tree.getroot()
            if root is None:
                raise ValueError("Root node is null.")
        except Exception as e:
            print(f"[{serial}] ‚ö†Ô∏è XML dump l·ªói ho·∫∑c r·ªóng: {e}")
            time.sleep(2)
            continue

        for node in root.iter():
            if (
                node.attrib.get("resource-id") == "com.google.android.youtube:id/shorts_edit_volume_button"
                and node.attrib.get("class") == "android.widget.Button"
                and node.attrib.get("content-desc", "").lower() == "volume"
                and node.attrib.get("enabled") == "true"
            ):
                print(f"[{serial}] ‚úÖ Giao di·ªán ch·ªânh √¢m l∆∞·ª£ng ƒë√£ s·∫µn s√†ng.")
                return True

        time.sleep(2)

    print(f"[{serial}] ‚ùå H·∫øt th·ªùi gian ch·ªù giao di·ªán √¢m l∆∞·ª£ng.")
    return False

def run(serial, song_name=None, api_key=None, voice_percent=100, music_percent=50):
    print(f"\n========== B·∫ÆT ƒê·∫¶U LU·ªíNG [{serial}] ==========")

    open_youtube(serial)

    if wait_until_ui_has(serial, "Create", timeout=10):
        tap_create_button(serial)

    if wait_until_ui_has(serial, "Short", timeout=10):
        tap_short_button(serial)

    if wait_until_ui_has(serial, "reel_camera_gallery_button_delegate", timeout=10):
        tap_add_gallery_button(serial)

        video_id = get_video_id_for_serial(serial)
        if video_id:
            tap_video_by_id(video_id, serial)
        else:
            print(f"[{serial}] ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y video ID trong video_assigned.json")

        tap_next_button(serial)
        tap_done_button(serial)

        if not wait_until_add_sound_visible(serial, max_wait=120):
            print(f"[{serial}] ‚ùå Kh√¥ng th·∫•y n√∫t Add sound sau khi upload xong.")
            return

        tap_add_sound_button(serial)

        if song_name:
            search_music(song_name, serial)
            time.sleep(2)
            pick_first_music_and_next(serial)
        else:
            print(f"[{serial}] ‚ö†Ô∏è Kh√¥ng c√≥ t√™n b√†i nh·∫°c ƒë∆∞·ª£c cung c·∫•p.")

        if not wait_until_ui_has(serial, "shorts_camera_next_button_delegate", timeout=20):
            print(f"[{serial}] ‚ùå Kh√¥ng t√¨m th·∫•y n√∫t V (Checkmark) sau khi th√™m nh·∫°c.")
            return

        tap_checkmark_button(serial)

        # üîä B·ªï sung qu√©t giao di·ªán ch·ªânh √¢m l∆∞·ª£ng b·∫±ng XML
        if wait_until_volume_ui_visible(serial, max_wait=60):
            adjust_volume_dynamic(serial, voice_percent, music_percent)
        else:
            print(f"[{serial}] ‚ö†Ô∏è B·ªè qua ch·ªânh volume v√¨ kh√¥ng th·∫•y giao di·ªán.")

        if not wait_until_ui_has(serial, "shorts_upload_button", timeout=20):
            print(f"[{serial}] ‚ùå Kh√¥ng t√¨m th·∫•y n√∫t Next cu·ªëi.")
        else:
            tap_next_button_final(serial)

        if video_id and api_key:
            set_title_from_video_id(video_id, api_key, serial)
        else:
            print(f"[{serial}] ‚ö†Ô∏è Thi·∫øu video_id ho·∫∑c api_key, kh√¥ng th·ªÉ ƒë·∫∑t ti√™u ƒë·ªÅ.")

    print(f"========== ‚úÖ K·∫æT TH√öC LU·ªíNG [{serial}] ==========\n")
